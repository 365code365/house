# 权限管理API单元测试

本目录包含了权限管理系统的完整单元测试，覆盖了所有主要的API接口。

## 测试覆盖范围

### 1. 角色管理API (`/api/admin/roles`)
- **GET**: 获取角色列表（支持分页、搜索、过滤）
- **POST**: 创建新角色
- **PUT**: 批量更新角色状态
- **DELETE**: 批量删除角色

### 2. 菜单权限API (`/api/admin/permissions/menus`)
- **GET**: 获取菜单列表（树状结构、扁平列表、权限信息）
- **POST**: 创建新菜单
- **PUT**: 更新角色菜单权限
- **DELETE**: 批量删除菜单

### 3. 按钮权限API (`/api/admin/permissions/buttons`)
- **GET**: 获取按钮权限列表（支持分页、搜索、权限信息）
- **POST**: 创建新按钮权限
- **PUT**: 更新角色按钮权限
- **DELETE**: 批量删除按钮权限

### 4. 用户权限API (`/api/admin/permissions/users`)
- **GET**: 获取用户列表（支持分页、搜索、过滤）
- **PUT**: 批量更新用户角色、状态、项目访问权限

### 5. 审计日志API (`/api/admin/audit-logs`)
- **GET**: 获取审计日志（支持分页、多种过滤条件、统计信息）
- **DELETE**: 清理旧审计日志

## 测试特点

### 完整的CRUD操作测试
- 创建、读取、更新、删除操作
- 批量操作处理
- 级联删除保护

### 权限验证测试
- 超级管理员权限验证
- 角色权限分配
- 菜单和按钮权限配置

### 数据验证测试
- 必填字段验证
- 重复数据检查
- 关联数据验证
- 系统预设角色保护

### 错误处理测试
- 无效参数处理
- 数据库错误处理
- 权限不足处理

### 审计日志测试
- 操作记录完整性
- 清理操作记录
- 统计信息准确性

## 运行测试

### 安装依赖
```bash
npm install
```

### 运行所有测试
```bash
npm test
```

### 运行特定测试文件
```bash
npm test roles.test.ts
npm test menus.test.ts
npm test buttons.test.ts
npm test users.test.ts
npm test audit-logs.test.ts
```

### 生成测试覆盖率报告
```bash
npm test -- --coverage
```

### 监听模式运行测试
```bash
npm test -- --watch
```

## 测试配置

### Jest配置
- 使用Next.js Jest配置
- 支持TypeScript
- 模块路径映射
- 测试环境配置

### Mock策略
- Prisma数据库操作Mock
- 认证工具Mock
- Next.js路由Mock
- 环境变量Mock

### 测试数据
- 模拟真实数据结构
- 覆盖各种边界情况
- 包含错误场景测试

## 测试最佳实践

### 测试结构
- 按API端点分组
- 每个HTTP方法独立测试
- 正向和异常场景覆盖

### 断言验证
- HTTP状态码验证
- 响应数据结构验证
- 业务逻辑验证
- 错误信息验证

### 清理和重置
- 每个测试前清理Mock
- 独立的测试数据
- 避免测试间相互影响

## 持续集成

### 自动化测试
- 代码提交时自动运行
- 构建前验证测试通过
- 覆盖率报告生成

### 质量门禁
- 测试通过率要求
- 覆盖率阈值设置
- 性能测试指标

## 故障排除

### 常见问题
1. **Mock不生效**: 检查Mock文件路径和导入
2. **类型错误**: 确保TypeScript配置正确
3. **测试超时**: 检查异步操作Mock
4. **环境变量**: 验证测试环境配置

### 调试技巧
- 使用`console.log`输出Mock调用
- 检查Jest配置和路径映射
- 验证测试数据格式
- 查看详细错误堆栈

## 扩展测试

### 新增API测试
1. 创建测试文件
2. 定义Mock数据
3. 编写测试用例
4. 验证覆盖完整性

### 集成测试
- 真实数据库连接
- 端到端API测试
- 性能压力测试

### 安全测试
- 权限绕过测试
- 注入攻击测试
- 认证绕过测试
