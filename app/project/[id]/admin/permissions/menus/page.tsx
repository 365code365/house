'use client'

import { useEffect, useState } from 'react'
import {
  Table,
  Button,
  Modal,
  Form,
  Input,
  Select,
  Switch,
  Tree,
  Card,
  Typography,
  Row,
  Col,
  Space,
  Popconfirm,
  message,
  Tag,
  Tooltip,
  Badge,
  Drawer,
  Checkbox,
  Divider,
  Alert
} from 'antd'
import {
  PlusOutlined,
  EditOutlined,
  DeleteOutlined,
  MenuOutlined,
  FolderOutlined,
  FileOutlined,
  SettingOutlined,
  TeamOutlined,
  EyeOutlined,
  BranchesOutlined
} from '@ant-design/icons'
import type { ColumnsType } from 'antd/es/table'
import type { DataNode } from 'antd/es/tree'

const { Title, Text } = Typography
const { Option } = Select
const { TextArea } = Input

interface Menu {
  id: number
  name: string
  displayName: string
  path?: string
  icon?: string
  parentId?: number
  sortOrder: number
  isActive: boolean
  description?: string
  children?: Menu[]
  parent?: {
    id: number
    displayName: string
  }
  rolePermissions?: Array<{
    role: {
      id: number
      name: string
      displayName: string
    }
  }>
  createdAt: string
  updatedAt: string
}

interface Role {
  id: number
  name: string
  displayName: string
  isActive: boolean
}

interface PermissionMatrix {
  [roleId: number]: {
    [menuId: number]: boolean
  }
}

export default function MenuPermissions() {
  const [menus, setMenus] = useState<Menu[]>([])
  const [roles, setRoles] = useState<Role[]>([])
  const [loading, setLoading] = useState(false)
  const [modalVisible, setModalVisible] = useState(false)
  const [matrixDrawerVisible, setMatrixDrawerVisible] = useState(false)
  const [editingMenu, setEditingMenu] = useState<Menu | null>(null)
  const [permissionMatrix, setPermissionMatrix] = useState<PermissionMatrix>({})
  const [expandedKeys, setExpandedKeys] = useState<React.Key[]>([])
  const [form] = Form.useForm()

  // Áç≤ÂèñËèúÂñÆÂàóË°®
  const fetchMenus = async () => {
    try {
      setLoading(true)
      const response = await fetch('/api/admin/permissions/menus')
      if (!response.ok) throw new Error('Áç≤ÂèñËèúÂñÆÂàóË°®Â§±Êïó')
      const data = await response.json()
      setMenus(data.data || [])
      
      // ÈªòË™çÂ±ïÈñãÊâÄÊúâÁØÄÈªû
      const allKeys = (data.data || []).map((menu: Menu) => menu.id)
      setExpandedKeys(allKeys)
    } catch (error) {
      console.error('Áç≤ÂèñËèúÂñÆÂàóË°®Â§±Êïó:', error)
      message.error('Áç≤ÂèñËèúÂñÆÂàóË°®Â§±Êïó')
    } finally {
      setLoading(false)
    }
  }

  // Áç≤ÂèñËßíËâ≤ÂàóË°®
  const fetchRoles = async () => {
    try {
      const response = await fetch('/api/admin/roles')
      if (!response.ok) throw new Error('Áç≤ÂèñËßíËâ≤ÂàóË°®Â§±Êïó')
      const data = await response.json()
      setRoles(data.data || [])
    } catch (error) {
      console.error('Áç≤ÂèñËßíËâ≤ÂàóË°®Â§±Êïó:', error)
    }
  }

  // Áç≤ÂèñÊ¨äÈôêÁü©Èô£
  const fetchPermissionMatrix = async () => {
    try {
      const matrix: PermissionMatrix = {}
      
      for (const role of roles) {
        const response = await fetch(`/api/admin/permissions/menus?roleId=${role.id}`)
        if (response.ok) {
          const data = await response.json()
          matrix[role.id] = {}
          
          data.data.forEach((menu: Menu) => {
            matrix[role.id][menu.id] = menu.rolePermissions?.some(
              rp => rp.role.id === role.id
            ) || false
          })
        }
      }
      
      setPermissionMatrix(matrix)
    } catch (error) {
      console.error('Áç≤ÂèñÊ¨äÈôêÁü©Èô£Â§±Êïó:', error)
    }
  }

  useEffect(() => {
    fetchMenus()
    fetchRoles()
  }, [])

  useEffect(() => {
    if (roles.length > 0) {
      fetchPermissionMatrix()
    }
  }, [roles])

  // ÂâµÂª∫ÊàñÊõ¥Êñ∞ËèúÂñÆ
  const handleSaveMenu = async (values: any) => {
    try {
      const url = editingMenu ? `/api/admin/permissions/menus/${editingMenu.id}` : '/api/admin/permissions/menus'
      const method = editingMenu ? 'PUT' : 'POST'
      
      const response = await fetch(url, {
        method,
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(values)
      })
      
      if (!response.ok) {
        const error = await response.json()
        throw new Error(error.error || 'Êìç‰ΩúÂ§±Êïó')
      }
      
      message.success(editingMenu ? 'ËèúÂñÆÊõ¥Êñ∞ÊàêÂäü' : 'ËèúÂñÆÂâµÂª∫ÊàêÂäü')
      setModalVisible(false)
      setEditingMenu(null)
      form.resetFields()
      fetchMenus()
    } catch (error: any) {
      console.error('‰øùÂ≠òËèúÂñÆÂ§±Êïó:', error)
      message.error(error.message || '‰øùÂ≠òËèúÂñÆÂ§±Êïó')
    }
  }

  // Âà™Èô§ËèúÂñÆ
  const handleDeleteMenu = async (menuId: number) => {
    try {
      const response = await fetch(`/api/admin/permissions/menus/${menuId}`, {
        method: 'DELETE'
      })
      
      if (!response.ok) {
        const error = await response.json()
        throw new Error(error.error || 'Âà™Èô§Â§±Êïó')
      }
      
      message.success('ËèúÂñÆÂà™Èô§ÊàêÂäü')
      fetchMenus()
    } catch (error: any) {
      console.error('Âà™Èô§ËèúÂñÆÂ§±Êïó:', error)
      message.error(error.message || 'Âà™Èô§ËèúÂñÆÂ§±Êïó')
    }
  }

  // Êõ¥Êñ∞Ê¨äÈôêÁü©Èô£
  const handleUpdatePermissionMatrix = async () => {
    try {
      const updates = []
      
      for (const roleId in permissionMatrix) {
        const menuIds = Object.keys(permissionMatrix[roleId])
          .filter(menuId => permissionMatrix[roleId][parseInt(menuId)])
          .map(menuId => parseInt(menuId))
        
        updates.push({
          roleId: parseInt(roleId),
          menuIds
        })
      }
      
      // ÊâπÈáèÊõ¥Êñ∞Ê¨äÈôê
      for (const update of updates) {
        const response = await fetch('/api/admin/permissions/menus', {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(update)
        })
        
        if (!response.ok) {
          throw new Error('Ê¨äÈôêÊõ¥Êñ∞Â§±Êïó')
        }
      }
      
      message.success('Ê¨äÈôêÁü©Èô£Êõ¥Êñ∞ÊàêÂäü')
      setMatrixDrawerVisible(false)
      fetchMenus()
    } catch (error: any) {
      console.error('Êõ¥Êñ∞Ê¨äÈôêÁü©Èô£Â§±Êïó:', error)
      message.error(error.message || 'Êõ¥Êñ∞Ê¨äÈôêÁü©Èô£Â§±Êïó')
    }
  }

  // ÊßãÂª∫ËèúÂñÆÊ®πÊï∏Êìö
  const buildMenuTree = (menus: Menu[]): DataNode[] => {
    const menuMap = new Map<number, Menu & { children: Menu[] }>()
    const roots: (Menu & { children: Menu[] })[] = []
    
    // ÂàùÂßãÂåñÊâÄÊúâËèúÂñÆ
    menus.forEach(menu => {
      menuMap.set(menu.id, { ...menu, children: [] })
    })
    
    // ÊßãÂª∫Ê®πÁµêÊßã
    menus.forEach(menu => {
      const menuNode = menuMap.get(menu.id)!
      if (menu.parentId && menuMap.has(menu.parentId)) {
        menuMap.get(menu.parentId)!.children.push(menuNode)
      } else {
        roots.push(menuNode)
      }
    })
    
    // ËΩâÊèõÁÇ∫TreeÁµÑ‰ª∂ÈúÄË¶ÅÁöÑÊï∏ÊìöÊ†ºÂºè
    const convertToTreeData = (nodes: (Menu & { children: Menu[] })[]): DataNode[] => {
      return nodes.map(node => ({
        key: node.id,
        title: (
          <div className="flex items-center justify-between w-full">
            <div className="flex items-center space-x-2">
              <span className="text-lg">
                {node.children && node.children.length > 0 ? 'üìÅ' : 'üìÑ'}
              </span>
              <span className="font-medium">{node.displayName}</span>
              <Text type="secondary" className="text-xs">({node.name})</Text>
              {!node.isActive && <Tag color="red">ÂÅúÁî®</Tag>}
            </div>
            <div className="flex items-center space-x-1">
              <Tooltip title="Á∑®ËºØ">
                <Button
                  type="text"
                  size="small"
                  icon={<EditOutlined />}
                  onClick={(e) => {
                    e.stopPropagation()
                    setEditingMenu(node)
                    form.setFieldsValue({
                      ...node,
                      parentId: node.parentId || undefined
                    })
                    setModalVisible(true)
                  }}
                />
              </Tooltip>
              <Tooltip title="Âà™Èô§">
                <Popconfirm
                  title="Á¢∫ÂÆöË¶ÅÂà™Èô§ÈÄôÂÄãËèúÂñÆÂóéÔºü"
                  description="Âà™Èô§ÂæåÂ∞áÁÑ°Ê≥ïÊÅ¢Âæ©Ôºå‰∏îÊúÉÂêåÊôÇÂà™Èô§ÊâÄÊúâÂ≠êËèúÂñÆ"
                  onConfirm={(e) => {
                    e?.stopPropagation()
                    handleDeleteMenu(node.id)
                  }}
                  okText="Á¢∫ÂÆö"
                  cancelText="ÂèñÊ∂à"
                >
                  <Button
                    type="text"
                    size="small"
                    danger
                    icon={<DeleteOutlined />}
                    onClick={(e) => e.stopPropagation()}
                  />
                </Popconfirm>
              </Tooltip>
            </div>
          </div>
        ),
        children: node.children && node.children.length > 0 ? convertToTreeData(node.children as (Menu & { children: Menu[] })[]) : undefined
      }))
    }
    
    return convertToTreeData(roots)
  }

  // Áç≤ÂèñÁà∂ËèúÂñÆÈÅ∏È†Ö
  const getParentMenuOptions = (excludeId?: number): Menu[] => {
    const filterMenus = (menus: Menu[]): Menu[] => {
      return menus.filter(menu => {
        if (excludeId && menu.id === excludeId) return false
        return true
      })
    }
    
    return filterMenus(menus)
  }

  const columns: ColumnsType<Menu> = [
    {
      title: 'ËèúÂñÆÂêçÁ®±',
      dataIndex: 'displayName',
      key: 'displayName',
      render: (text, record) => (
        <div className="flex items-center space-x-2">
          {record.parentId ? (
            <FileOutlined className="text-gray-500" />
          ) : (
            <FolderOutlined className="text-blue-500" />
          )}
          <div>
            <div className="font-medium">{text}</div>
            <Text type="secondary" className="text-xs">{record.name}</Text>
          </div>
        </div>
      )
    },
    {
      title: 'Ë∑ØÂæë',
      dataIndex: 'path',
      key: 'path',
      render: (path) => path && <Text code>{path}</Text>
    },
    {
      title: 'Áà∂ËèúÂñÆ',
      dataIndex: 'parent',
      key: 'parent',
      render: (parent) => parent?.displayName || '-'
    },
    {
      title: 'ÊéíÂ∫è',
      dataIndex: 'sortOrder',
      key: 'sortOrder',
      width: 80
    },
    {
      title: 'ÁãÄÊÖã',
      dataIndex: 'isActive',
      key: 'isActive',
      render: (isActive) => (
        <Badge
          status={isActive ? 'success' : 'default'}
          text={isActive ? 'ÂïüÁî®' : 'ÂÅúÁî®'}
        />
      )
    },
    {
      title: 'Ê¨äÈôêËßíËâ≤',
      key: 'roles',
      render: (_, record) => (
        <div className="flex flex-wrap gap-1">
          {record.rolePermissions?.map(rp => (
            <Tag key={rp.role.id} color="blue" className="text-xs">
              {rp.role.displayName}
            </Tag>
          )) || <Text type="secondary">ÁÑ°</Text>}
        </div>
      )
    }
  ]

  return (
    <div className="space-y-6">
      {/* È†ÅÈù¢Ê®ôÈ°å */}
      <div className="flex items-center justify-between">
        <div>
          <Title level={3} className="!mb-2">
            <MenuOutlined className="mr-2" />
            ËèúÂñÆÊ¨äÈôêÁÆ°ÁêÜ
          </Title>
          <Text type="secondary">ÁÆ°ÁêÜÁ≥ªÁµ±ËèúÂñÆÁµêÊßãÂíåËßíËâ≤Ê¨äÈôêÈÖçÁΩÆ</Text>
        </div>
        <Space>
          <Button
            icon={<BranchesOutlined />}
            onClick={() => {
              fetchPermissionMatrix()
              setMatrixDrawerVisible(true)
            }}
          >
            Ê¨äÈôêÁü©Èô£
          </Button>
          <Button
            type="primary"
            icon={<PlusOutlined />}
            onClick={() => {
              setEditingMenu(null)
              form.resetFields()
              setModalVisible(true)
            }}
          >
            Êñ∞Â¢ûËèúÂñÆ
          </Button>
        </Space>
      </div>

      {/* Áµ±Ë®à‰ø°ÊÅØ */}
      <Row gutter={[16, 16]}>
        <Col xs={24} sm={8}>
          <Card>
            <div className="flex items-center justify-between">
              <div>
                <Text type="secondary">Á∏ΩËèúÂñÆÊï∏</Text>
                <div className="text-2xl font-bold text-blue-600">{menus.length}</div>
              </div>
              <MenuOutlined className="text-3xl text-blue-500" />
            </div>
          </Card>
        </Col>
        <Col xs={24} sm={8}>
          <Card>
            <div className="flex items-center justify-between">
              <div>
                <Text type="secondary">Ê†πËèúÂñÆ</Text>
                <div className="text-2xl font-bold text-green-600">
                  {menus.filter(m => !m.parentId).length}
                </div>
              </div>
              <FolderOutlined className="text-3xl text-green-500" />
            </div>
          </Card>
        </Col>
        <Col xs={24} sm={8}>
          <Card>
            <div className="flex items-center justify-between">
              <div>
                <Text type="secondary">ÂïüÁî®ËèúÂñÆ</Text>
                <div className="text-2xl font-bold text-orange-600">
                  {menus.filter(m => m.isActive).length}
                </div>
              </div>
              <SettingOutlined className="text-3xl text-orange-500" />
            </div>
          </Card>
        </Col>
      </Row>

      {/* ËèúÂñÆÊ®πË¶ñÂúñ */}
      <Row gutter={[16, 16]}>
        <Col xs={24} lg={12}>
          <Card title="ËèúÂñÆÊ®πÁµêÊßã" className="h-96">
            <div className="h-80 overflow-auto">
              <Tree
                treeData={buildMenuTree(menus)}
                expandedKeys={expandedKeys}
                onExpand={setExpandedKeys}
                showLine
                showIcon={false}
              />
            </div>
          </Card>
        </Col>
        <Col xs={24} lg={12}>
          <Card title="ËèúÂñÆÂàóË°®" className="h-96">
            <div className="h-80 overflow-auto">
              <Table
                columns={columns}
                dataSource={menus}
                rowKey="id"
                loading={loading}
                pagination={false}
                size="small"
              />
            </div>
          </Card>
        </Col>
      </Row>

      {/* ÂâµÂª∫/Á∑®ËºØËèúÂñÆÊ®°ÊÖãÊ°Ü */}
      <Modal
        title={editingMenu ? 'Á∑®ËºØËèúÂñÆ' : 'Êñ∞Â¢ûËèúÂñÆ'}
        open={modalVisible}
        onCancel={() => {
          setModalVisible(false)
          setEditingMenu(null)
          form.resetFields()
        }}
        footer={null}
        width={600}
      >
        <Form
          form={form}
          layout="vertical"
          onFinish={handleSaveMenu}
        >
          <Row gutter={16}>
            <Col span={12}>
              <Form.Item
                name="name"
                label="ËèúÂñÆÊ®ôË≠ò"
                rules={[
                  { required: true, message: 'Ë´ãËº∏ÂÖ•ËèúÂñÆÊ®ôË≠ò' },
                  { pattern: /^[a-zA-Z][a-zA-Z0-9_]*$/, message: 'ËèúÂñÆÊ®ôË≠òÊ†ºÂºè‰∏çÊ≠£Á¢∫' }
                ]}
              >
                <Input placeholder="‰æãÂ¶ÇÔºöuser_management" />
              </Form.Item>
            </Col>
            <Col span={12}>
              <Form.Item
                name="displayName"
                label="È°ØÁ§∫ÂêçÁ®±"
                rules={[{ required: true, message: 'Ë´ãËº∏ÂÖ•È°ØÁ§∫ÂêçÁ®±' }]}
              >
                <Input placeholder="‰æãÂ¶ÇÔºöÁî®Êà∂ÁÆ°ÁêÜ" />
              </Form.Item>
            </Col>
          </Row>
          
          <Row gutter={16}>
            <Col span={12}>
              <Form.Item
                name="path"
                label="ËèúÂñÆË∑ØÂæë"
              >
                <Input placeholder="‰æãÂ¶ÇÔºö/admin/users" />
              </Form.Item>
            </Col>
            <Col span={12}>
              <Form.Item
                name="icon"
                label="ÂúñÊ®ô"
              >
                <Input placeholder="‰æãÂ¶ÇÔºöUserOutlined" />
              </Form.Item>
            </Col>
          </Row>
          
          <Row gutter={16}>
            <Col span={12}>
              <Form.Item
                name="parentId"
                label="Áà∂ËèúÂñÆ"
              >
                <Select
                  placeholder="ÈÅ∏ÊìáÁà∂ËèúÂñÆÔºàÂèØÈÅ∏Ôºâ"
                  allowClear
                >
                  {getParentMenuOptions(editingMenu?.id).map(menu => (
                    <Option key={menu.id} value={menu.id}>
                      {menu.displayName}
                    </Option>
                  ))}
                </Select>
              </Form.Item>
            </Col>
            <Col span={12}>
              <Form.Item
                name="sortOrder"
                label="ÊéíÂ∫èÈ†ÜÂ∫è"
                initialValue={0}
              >
                <Input type="number" placeholder="Êï∏Â≠óË∂äÂ∞èË∂äÈù†Ââç" />
              </Form.Item>
            </Col>
          </Row>
          
          <Form.Item
            name="description"
            label="ËèúÂñÆÊèèËø∞"
          >
            <TextArea rows={3} placeholder="ÊèèËø∞ËèúÂñÆÁöÑÂäüËÉΩÂíåÁî®ÈÄî" />
          </Form.Item>
          
          <Form.Item
            name="isActive"
            label="ÂïüÁî®ÁãÄÊÖã"
            valuePropName="checked"
            initialValue={true}
          >
            <Switch checkedChildren="ÂïüÁî®" unCheckedChildren="ÂÅúÁî®" />
          </Form.Item>
          
          <div className="flex justify-end space-x-2">
            <Button onClick={() => setModalVisible(false)}>ÂèñÊ∂à</Button>
            <Button type="primary" htmlType="submit">
              {editingMenu ? 'Êõ¥Êñ∞' : 'ÂâµÂª∫'}
            </Button>
          </div>
        </Form>
      </Modal>

      {/* Ê¨äÈôêÁü©Èô£ÊäΩÂ±ú */}
      <Drawer
        title="ËèúÂñÆÊ¨äÈôêÁü©Èô£"
        open={matrixDrawerVisible}
        onClose={() => setMatrixDrawerVisible(false)}
        width={800}
        footer={
          <div className="flex justify-end space-x-2">
            <Button onClick={() => setMatrixDrawerVisible(false)}>ÂèñÊ∂à</Button>
            <Button type="primary" onClick={handleUpdatePermissionMatrix}>
              ‰øùÂ≠òÈÖçÁΩÆ
            </Button>
          </div>
        }
      >
        <Alert
          message="Ê¨äÈôêÁü©Èô£ÈÖçÁΩÆ"
          description="ÂãæÈÅ∏Ë°®Á§∫Ë©≤ËßíËâ≤ÊìÅÊúâÂ∞çÊáâËèúÂñÆÁöÑË®™ÂïèÊ¨äÈôê"
          type="info"
          showIcon
          className="mb-4"
        />
        
        <div className="overflow-x-auto">
          <table className="w-full border-collapse border border-gray-300">
            <thead>
              <tr className="bg-gray-50">
                <th className="border border-gray-300 p-2 text-left">ËèúÂñÆ</th>
                {roles.map(role => (
                  <th key={role.id} className="border border-gray-300 p-2 text-center min-w-24">
                    <div className="text-xs">{role.displayName}</div>
                  </th>
                ))}
              </tr>
            </thead>
            <tbody>
              {menus.map(menu => (
                <tr key={menu.id} className="hover:bg-gray-50">
                  <td className="border border-gray-300 p-2">
                    <div className="flex items-center space-x-2">
                      {menu.parentId ? (
                        <span className="ml-4 text-gray-400">‚îî‚îÄ</span>
                      ) : null}
                      <span className="font-medium">{menu.displayName}</span>
                      <Text type="secondary" className="text-xs">({menu.name})</Text>
                    </div>
                  </td>
                  {roles.map(role => (
                    <td key={role.id} className="border border-gray-300 p-2 text-center">
                      <Checkbox
                        checked={permissionMatrix[role.id]?.[menu.id] || false}
                        onChange={(e) => {
                          setPermissionMatrix(prev => ({
                            ...prev,
                            [role.id]: {
                              ...prev[role.id],
                              [menu.id]: e.target.checked
                            }
                          }))
                        }}
                      />
                    </td>
                  ))}
                </tr>
              ))}
            </tbody>
          </table>
        </div>
      </Drawer>
    </div>
  )
}