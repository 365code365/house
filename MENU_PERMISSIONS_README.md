# 菜單權限管理系統

## 概述

本系統提供完整的菜單權限管理功能，包括菜單結構管理、角色權限配置和權限矩陣管理。

## 功能特性

### 1. 菜單結構管理
- **樹狀結構顯示**: 以樹狀圖形式展示菜單層級關係
- **菜單操作**: 支持新增、編輯、刪除菜單
- **層級管理**: 支持父子菜單關係，最多支持多級嵌套
- **排序控制**: 每個菜單可設置排序順序

### 2. 菜單屬性
- **基本信息**: 菜單標識、顯示名稱、路徑、圖標
- **狀態控制**: 啟用/停用狀態
- **描述信息**: 可選的菜單描述
- **父菜單**: 支持選擇父菜單建立層級關係

### 3. 權限矩陣
- **角色權限配置**: 為每個角色配置菜單訪問權限
- **批量操作**: 支持批量更新權限配置
- **權限審計**: 記錄所有權限變更操作

## 預設菜單結構

系統已預設以下菜單結構：

### 根菜單
1. **數據統計** (`/statistics`) - 系統數據統計功能
2. **銷控總表** (`/sales-control-group`) - 銷控相關功能組
3. **客戶預約** (`/appointments`) - 客戶預約管理
4. **已購客名單** (`/purchased-customers`) - 已購客戶管理
5. **銷售人員管理** (`/sales-personnel`) - 銷售人員管理
6. **訪客問卷** (`/visitor-questionnaire`) - 訪客問卷管理
7. **財務系統** (`/financial-group`) - 財務相關功能組
8. **點交屋管理** (`/handover`) - 點交屋流程管理
9. **退戶記錄** (`/withdrawal`) - 退戶記錄管理

### 子菜單

#### 銷控總表組
- 銷控管理 (`/sales-control`)
- 銷售概況 (`/sales-overview`)
- 停車位總表 (`/parking`)

#### 財務系統組
- 財務總覽 (`/financial`)
- 預算規劃 (`/budget`)
- 支出管理 (`/expenses`)
- 請傭列表 (`/commission`)

## 使用方法

### 1. 訪問菜單權限管理
```
http://localhost:3000/project/1/admin/permissions/menus
```

### 2. 查看菜單結構
- **樹狀視圖**: 左側顯示菜單的層級結構
- **列表視圖**: 右側顯示菜單的詳細信息
- **統計信息**: 頂部顯示菜單總數、根菜單數、啟用菜單數

### 3. 管理菜單
- **新增菜單**: 點擊"新增菜單"按鈕
- **編輯菜單**: 在樹狀圖或列表中點擊編輯按鈕
- **刪除菜單**: 在樹狀圖或列表中點擊刪除按鈕

### 4. 配置權限
- **權限矩陣**: 點擊"權限矩陣"按鈕
- **角色權限**: 為每個角色勾選可訪問的菜單
- **保存配置**: 點擊"保存配置"按鈕

## 數據庫結構

### 主要表
- `menus`: 菜單基本信息
- `role_menu_permissions`: 角色菜單權限
- `permission_audit_logs`: 權限操作審計日誌

### 菜單表字段
- `id`: 主鍵
- `name`: 菜單標識（唯一）
- `display_name`: 顯示名稱
- `path`: 菜單路徑
- `icon`: 圖標名稱
- `parent_id`: 父菜單ID
- `sort_order`: 排序順序
- `is_active`: 啟用狀態
- `created_at`: 創建時間
- `updated_at`: 更新時間

## 初始化腳本

使用以下命令初始化預設菜單結構：

```bash
node scripts/init-menu-structure.cjs
```

## 注意事項

1. **權限要求**: 只有超級管理員可以訪問菜單權限管理
2. **刪除限制**: 有子菜單的菜單無法直接刪除
3. **路徑唯一性**: 菜單路徑在系統中應保持唯一
4. **層級限制**: 建議菜單層級不超過3級
5. **權限繼承**: 子菜單的權限會影響父菜單的顯示

## 擴展功能

### 1. 按鈕權限
- 支持菜單內按鈕級別的權限控制
- 可配置增刪改查等操作權限

### 2. 動態菜單
- 支持根據用戶角色動態生成菜單
- 支持菜單的條件顯示

### 3. 權限緩存
- 支持權限配置的緩存機制
- 提高權限檢查的性能

## 技術實現

- **前端**: React + Ant Design + TypeScript
- **後端**: Next.js API Routes
- **數據庫**: MySQL + Prisma ORM
- **認證**: NextAuth.js
- **權限**: RBAC (基於角色的訪問控制)

## 故障排除

### 常見問題

1. **菜單不顯示**: 檢查菜單是否啟用，用戶是否有權限
2. **權限不生效**: 檢查權限矩陣配置，清除瀏覽器緩存
3. **數據庫錯誤**: 檢查數據庫連接，運行數據庫遷移

### 日誌查看

權限相關操作會記錄在 `permission_audit_logs` 表中，包括：
- 操作類型（創建、更新、刪除）
- 操作資源（菜單、權限）
- 操作前後數據
- 操作時間和用戶信息


