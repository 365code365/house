# 房地產銷控管理系統完整開發計劃

## 1. 項目概述

基於系統規格滿足度分析報告，現有系統滿足度僅約30%，需要進行全面的系統重構和功能完善。本文檔提供完整的開發計劃，以實現一個功能完整、安全可靠的房地產銷控管理系統。

### 1.1 現狀分析
- **技術架構**：✅ 完全滿足（Next.js + TypeScript + MySQL）
- **數據模型**：✅ 高度滿足（Prisma Schema完整）
- **權限管理**：❌ 完全缺失（最嚴重問題）
- **核心功能**：⚠️ 大部分缺失（僅30%完成度）
- **系統安全**：❌ 完全缺失

## 2. 權限管理系統設計（高優先級）

### 2.1 用戶角色模型

```typescript
// 新增用戶角色枚舉
enum UserRole {
  SYSTEM_ADMIN = 'SYSTEM_ADMIN',      // 系統管理員
  SALES_PERSONNEL = 'SALES_PERSONNEL' // 銷售人員
}

// 新增用戶模型
model User {
  id          Int      @id @default(autoincrement())
  email       String   @unique
  password    String   // bcrypt加密
  name        String
  role        UserRole @default(SALES_PERSONNEL)
  employeeNo  String?  @unique // 員工編號
  projectIds  String?  // 可訪問的項目ID列表
  isActive    Boolean  @default(true)
  lastLogin   DateTime?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@map("user")
}
```

### 2.2 權限控制矩陣

| 功能模塊 | 系統管理員 | 銷售人員 |
|---------|-----------|----------|
| 項目管理 | 全部權限 | 僅分配項目 |
| 銷控管理 | 全部權限 | 僅自己銷售的戶型 |
| 停車位管理 | 全部權限 | 僅自己銷售的車位 |
| 客戶管理 | 全部權限 | 僅自己的客戶 |
| 財務管理 | 全部權限 | 僅查看權限 |
| 系統設置 | 全部權限 | 無權限 |
| 數據導出 | 全部權限 | 僅自己數據 |

### 2.3 認證系統實現

#### NextAuth.js 配置
```typescript
// lib/auth.ts
import NextAuth from 'next-auth'
import CredentialsProvider from 'next-auth/providers/credentials'
import bcrypt from 'bcryptjs'
import { prisma } from './db'

export const authOptions = {
  providers: [
    CredentialsProvider({
      name: 'credentials',
      credentials: {
        email: { label: 'Email', type: 'email' },
        password: { label: 'Password', type: 'password' }
      },
      async authorize(credentials) {
        if (!credentials?.email || !credentials?.password) return null
        
        const user = await prisma.user.findUnique({
          where: { email: credentials.email }
        })
        
        if (!user || !user.isActive) return null
        
        const isValid = await bcrypt.compare(credentials.password, user.password)
        if (!isValid) return null
        
        return {
          id: user.id.toString(),
          email: user.email,
          name: user.name,
          role: user.role,
          projectIds: user.projectIds
        }
      }
    })
  ],
  session: { strategy: 'jwt' },
  pages: {
    signIn: '/auth/signin',
    error: '/auth/error'
  }
}
```

#### 路由保護中間件
```typescript
// middleware.ts
import { withAuth } from 'next-auth/middleware'

export default withAuth(
  function middleware(req) {
    const { pathname } = req.nextUrl
    const token = req.nextauth.token
    
    // 管理員路由保護
    if (pathname.startsWith('/admin') && token?.role !== 'SYSTEM_ADMIN') {
      return new Response('Forbidden', { status: 403 })
    }
    
    // 項目權限檢查
    if (pathname.includes('/project/')) {
      const projectId = pathname.split('/project/')[1]?.split('/')[0]
      if (token?.role === 'SALES_PERSONNEL') {
        const allowedProjects = token.projectIds?.split(',') || []
        if (!allowedProjects.includes(projectId)) {
          return new Response('Forbidden', { status: 403 })
        }
      }
    }
  },
  {
    callbacks: {
      authorized: ({ token }) => !!token
    }
  }
)

export const config = {
  matcher: ['/project/:path*', '/admin/:path*']
}
```

### 2.4 API權限驗證

```typescript
// lib/auth-utils.ts
export async function verifyApiAccess(req: NextRequest, requiredRole?: UserRole) {
  const session = await getServerSession(authOptions)
  
  if (!session?.user) {
    throw new Error('Unauthorized')
  }
  
  if (requiredRole && session.user.role !== requiredRole && session.user.role !== 'SYSTEM_ADMIN') {
    throw new Error('Forbidden')
  }
  
  return session.user
}

export function hasProjectAccess(user: any, projectId: string): boolean {
  if (user.role === 'SYSTEM_ADMIN') return true
  
  const allowedProjects = user.projectIds?.split(',') || []
  return allowedProjects.includes(projectId)
}
```

## 3. 數據模型完善方案

### 3.1 銷控管理字段補充

```sql
-- 添加缺失字段到 sales_control 表
ALTER TABLE sales_control ADD COLUMN buyer_count INT DEFAULT 1;
ALTER TABLE sales_control ADD COLUMN order_date DATE;
ALTER TABLE sales_control ADD COLUMN contract_date DATE;
ALTER TABLE sales_control ADD COLUMN custom_requirements TEXT;
ALTER TABLE sales_control ADD COLUMN balcony_area DECIMAL(10,2);
ALTER TABLE sales_control ADD COLUMN gift_info TEXT;
ALTER TABLE sales_control ADD COLUMN payment_method VARCHAR(50);
ALTER TABLE sales_control ADD COLUMN loan_bank VARCHAR(100);
ALTER TABLE sales_control ADD COLUMN loan_amount DECIMAL(15,2);
```

### 3.2 新增退戶管理模型

```typescript
model WithdrawalRequest {
  id              Int                    @id @default(autoincrement())
  houseNo         String                 @map("house_no")
  customerName    String                 @map("customer_name")
  withdrawalDate  DateTime               @map("withdrawal_date")
  reason          String
  refundAmount    Decimal                @map("refund_amount") @db.Decimal(15,2)
  status          WithdrawalStatus       @default(PENDING)
  approvedBy      String?                @map("approved_by")
  approvedAt      DateTime?              @map("approved_at")
  notes           String?
  projectId       Int                    @map("project_id")
  createdAt       DateTime               @default(now()) @map("created_at")
  updatedAt       DateTime               @updatedAt @map("updated_at")
  
  project         Project                @relation(fields: [projectId], references: [id])
  
  @@map("withdrawal_request")
}

enum WithdrawalStatus {
  PENDING    @map("待審核")
  APPROVED   @map("已批准")
  REJECTED   @map("已拒絕")
  COMPLETED  @map("已完成")
}
```

## 4. 核心功能模塊實現計劃

### 4.1 第一階段：權限管理系統（1週）

**任務清單：**
1. ✅ 實現用戶認證系統（NextAuth.js）
2. ✅ 創建用戶管理界面
3. ✅ 實現角色權限控制
4. ✅ 添加路由保護中間件
5. ✅ 實現API權限驗證
6. ✅ 創建登錄/登出界面

**技術要點：**
- 使用 bcrypt 進行密碼加密
- JWT token 管理
- 會話持久化
- 權限檢查中間件

### 4.2 第二階段：銷控管理完善（1週）

**任務清單：**
1. ✅ 完善銷控數據模型
2. ✅ 實現Excel導入導出功能
3. ✅ 添加退戶管理功能
4. ✅ 實現實時編輯功能
5. ✅ 添加權限控制
6. ✅ 優化搜索和篩選功能

**技術實現：**
```typescript
// Excel 導入導出
import * as XLSX from 'xlsx'

export async function importSalesData(file: File, projectId: string) {
  const workbook = XLSX.read(await file.arrayBuffer())
  const worksheet = workbook.Sheets[workbook.SheetNames[0]]
  const data = XLSX.utils.sheet_to_json(worksheet)
  
  // 數據驗證和導入邏輯
  for (const row of data) {
    await prisma.salesControl.create({
      data: {
        houseNo: row['房屋編號'],
        building: row['樓棟'],
        floor: parseInt(row['樓層']),
        unit: row['單元'],
        area: parseFloat(row['面積']),
        unitPrice: parseFloat(row['單價']),
        projectId: parseInt(projectId)
      }
    })
  }
}
```

### 4.3 第三階段：客戶管理系統（1週）

**功能模塊：**
1. ✅ 客戶預約管理
2. ✅ 已購客戶名單
3. ✅ 訪客問卷系統
4. ✅ 客戶評級管理
5. ✅ 客戶跟進記錄

### 4.4 第四階段：財務管理系統（1週）

**功能模塊：**
1. ✅ 預算規劃管理
2. ✅ 支出管理
3. ✅ 佣金計算和管理
4. ✅ 訂金管理
5. ✅ 財務報表生成

### 4.5 第五階段：系統優化（1週）

**優化項目：**
1. ✅ 性能優化
2. ✅ 用戶體驗改進
3. ✅ 數據統計和圖表
4. ✅ 移動端適配
5. ✅ 系統測試和部署

## 5. 安全性改進措施

### 5.1 數據安全
- 敏感數據加密存儲
- API請求限流
- SQL注入防護
- XSS攻擊防護

### 5.2 訪問控制
- 多因素認證（可選）
- 會話超時管理
- 操作日誌記錄
- 異常登錄檢測

### 5.3 數據備份
- 定期數據庫備份
- 災難恢復計劃
- 數據完整性檢查

## 6. 技術架構優化

### 6.1 前端架構
```
├── app/
│   ├── auth/                 # 認證相關頁面
│   ├── admin/                # 管理員專用頁面
│   ├── project/[id]/         # 項目相關頁面
│   │   ├── sales-control/    # 銷控管理
│   │   ├── customers/        # 客戶管理
│   │   ├── finance/          # 財務管理
│   │   └── reports/          # 報表統計
│   └── api/                  # API路由
├── components/
│   ├── auth/                 # 認證組件
│   ├── common/               # 通用組件
│   └── protected/            # 權限保護組件
├── lib/
│   ├── auth.ts              # 認證配置
│   ├── permissions.ts       # 權限管理
│   └── security.ts          # 安全工具
└── middleware.ts            # 路由保護
```

### 6.2 API設計規範
```typescript
// 統一API響應格式
interface ApiResponse<T> {
  success: boolean
  data?: T
  error?: string
  message?: string
  pagination?: {
    page: number
    limit: number
    total: number
  }
}

// 權限檢查裝飾器
export function requireAuth(requiredRole?: UserRole) {
  return function (target: any, propertyKey: string, descriptor: PropertyDescriptor) {
    const originalMethod = descriptor.value
    
    descriptor.value = async function (...args: any[]) {
      const req = args[0] as NextRequest
      const user = await verifyApiAccess(req, requiredRole)
      
      return originalMethod.apply(this, [...args, user])
    }
  }
}
```

## 7. 測試策略

### 7.1 單元測試
- 權限驗證邏輯測試
- 數據模型驗證測試
- API接口測試

### 7.2 集成測試
- 用戶認證流程測試
- 權限控制測試
- 數據導入導出測試

### 7.3 安全測試
- 權限繞過測試
- SQL注入測試
- XSS攻擊測試

## 8. 部署和運維

### 8.1 環境配置
```bash
# 生產環境變量
DATABASE_URL="mysql://user:password@host:port/database"
NEXTAUTH_SECRET="your-secret-key"
NEXTAUTH_URL="https://your-domain.com"
ENCRYPTION_KEY="your-encryption-key"
```

### 8.2 監控和日誌
- 應用性能監控
- 錯誤日誌收集
- 用戶行為分析
- 安全事件監控

## 9. 開發時程規劃

| 階段 | 時間 | 主要任務 | 交付物 |
|------|------|----------|--------|
| 第1週 | Week 1 | 權限管理系統 | 用戶認證、角色權限 |
| 第2週 | Week 2 | 銷控管理完善 | Excel導入導出、退戶管理 |
| 第3週 | Week 3 | 客戶管理系統 | 預約管理、客戶名單 |
| 第4週 | Week 4 | 財務管理系統 | 預算、佣金、訂金管理 |
| 第5週 | Week 5 | 系統優化測試 | 性能優化、安全測試 |

## 10. 風險評估和應對

### 10.1 技術風險
- **風險**：權限系統複雜度高
- **應對**：分階段實現，充分測試

### 10.2 安全風險
- **風險**：數據洩露風險
- **應對**：多層安全防護，定期安全審計

### 10.3 性能風險
- **風險**：大數據量處理性能
- **應對**：數據庫優化，分頁查詢

## 11. 成功指標

- ✅ 系統安全性：通過安全測試，無重大漏洞
- ✅ 功能完整性：實現規格要求的所有功能
- ✅ 性能指標：頁面加載時間 < 3秒
- ✅ 用戶體驗：用戶滿意度 > 90%
- ✅ 系統穩定性：99.9% 可用性

---

**總結**：本開發計劃將系統滿足度從30%提升至100%，重點解決權限管理、功能完整性和系統安全性問題，確保交付一個功能完整、安全可靠的房地產銷控管理系統。